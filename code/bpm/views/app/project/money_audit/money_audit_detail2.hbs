<link rel="stylesheet" type="text/css" href="{{projcfg.appurl}}/static/{{projcfg.theme}}webuploade/webuploader.css">
<script src="{{projcfg.appurl}}/static/{{projcfg.theme}}webuploade/webuploader.js"></script>
    <div class="easyui-tabs" id="tabs" >
        <div title="工单信息" style="padding:10px">
        <legend ><b>任务基本信息</b></legend>
        <form id="orderDetailForm1" method="post" enctype="multipart/form-data">
            <table cellpadding="5" align="center" style="border-collapse:separate; border-spacing:0px 5px;">

                <input  type="hidden"id="node_code"  name="proc_inst_task_code"/>
                <input  type="hidden"id="next_code" name="next_code" />
                <input  type="hidden"id="proc_inst_id"  name="proc_inst_id"/>
                <input  type="hidden"id="proc_task_id"  name="proc_task_id"/>
                <input  type="hidden"id="proc_task_code"  name="proc_task_code"/>

                <tr>
                    <td align="right" class="tdLabel">工单标题:</td>
                    <td colspan="3"><input disabled style="width: 665px" class="easyui-textbox"data-options="required:true, missingMessage:'请输入工单标题'" id="proc_inst_task_title" name="proc_inst_task_title" ></input></td>
                </tr>
                <tr>
                    <td align="right" class="tdLabel">工单类型:</td>
                    <td>
                        <input disabled style="width: 280px"class="easyui-textbox"
                               id="proc_inst_name1" name="proc_inst_name"></input>
                    </td>

                    <td align="right" class="tdLabel">工作天数:</td>
                    <td><input disabled style="width: 280px"class="easyui-numberbox"data-options="precision:0"  name="work_day" id="work_day"
                    ></input></td>
                </tr>
                <tr>
                    <td align="right" class="tdLabel">开始时间:</td>
                    <td><input disabled style="width: 280px"class="easyui-textbox"
                               id="start_time" name="start_time"></input></td>
                    <td align="right" class="tdLabel">完成时间:</td>
                    <td><input disabled style="width: 280px"  class="easyui-textbox"
                               id="end_time" name="end_time"></input></td>
                    <td colspan="2"></td>


                </tr>
                <tr>
                    <td align="right" class="tdLabel">发起人角色:</td>
                    <td><input disabled style="width: 280px"class="easyui-textbox"
                               name="role_name" ></input></td>

                    <td align="right" class="tdLabel">发起人:</td>
                    <td><input disabled style="width: 280px" class="easyui-textbox"
                               name="user_name" ></input></td>

                </tr>


                <tr>
                    <td align="right" class="tdLabel">派单内容:</td>
                    <td colspan="3"><input disabled
                                           style="width: 670px; height: 100px; resize: none;" cols="30"
                                           name="proc_content" rows="4"  class="easyui-textbox"  labelPosition="top" multiline="true"/>

                    </td>
                </tr>
            </table>

            <legend><b>流程日志</b></legend>
            <table cellpadding="5" align="center">
                <tr>
                    <td colspan="4">
                        <table id="dg"></table>
                    </td>
                </tr>

            </table>

            <fieldset id="order_detail">
            <legend><b>节点处理</b></legend>

            <table  cellpadding="5" align="center" style="border-collapse:separate; border-spacing:0px 5px;">


                <tr>
                    <td align="right" class="tdLabel">当前节点:</td>
                    <td colspan="3"><input disabled style="width: 670px" class="easyui-textbox" name="proc_inst_task_name" id="proc_inst_task_name" ></input></td>



                </tr>
                <tr id="tr_4">
                    <td align="right" class="tdLabel">操作:</td>
                    <td colspan="3" class="tdLabel">
                        <select class="easyui-combobox" name="handle"
                                style="width: 80px;" id="handle"   panelHeight="auto">

                        </select>


                    </td>
                </tr>
                <tr id="tr_5">
                    <td align="right" class="tdLabel">下一节点处理人:</td>
                    <td colspan="3"><select class="easyui-combobox"
                                            id="assign_user_no" name="assign_user_no"  style="width: 180px;">
                        <!--<option value="admin">系统管理员</option>-->
                    </select> </td>


                </tr>
                <tr>
                    <td align="right" class="tdLabel">处理意见:</td>
                    <td colspan="2"><input name="memo" class="easyui-textbox"  labelPosition="top" multiline="true" style="width: 670px; height: 54px; resize: none;"/>

                    </td>

                </tr>
                <tr>
                    <td align="right" class="tdLabel"></td>
                    <td colspan="2">
                        <span style="color:rgba(247,0,0,0.61);font-size:12px">上传附件的格式为:GIF,JPG,JPEG,BPM,PNG,MP3,WAV,WMA,PDF,TXT,XLS,XLSX</span>
                    </td>
                </tr>

                <tr  id="fileUpload">
                    <td align="right" class="tdLabel">附件上传:</td>
                    <td>  <!--<input type="file"labelPosition="top"id="files" name="files" multiple="true" data-options="prompt:'选择文件...',buttonText:'选择'" style="width:250px"/>-->
                        <div id="uploader" class="wu-example">
                            <!--用来存放文件信息-->


                            <div id="picker"  >选择文件</div>

                            <div id="thelist" class="uploader-list" ></div>
                        </div>
                    </td>
                </tr>

                <input type='hidden' name='_csrf' value='{{ _csrfToken }}'/>

            </table>
                <div style="padding:5px 0;" align="center" id="button_group">
                    <a href="javascript:void(0);" class="easyui-linkbutton" onclick="submitTask()" style="width: 100px;">提交</a>
                </div>
            </fieldset>

        </form>


</div>
        <div title="流程图" style="padding:10px">

            <iframe id="iframeId" frameborder=0 width=1200 height=830 marginheight=0 marginwidth=0 scrolling=no src=></iframe>
        </div>
        <div title="附件" style="padding:10px">
            <table cellpadding="5" align="center">
                <!--<tr  id="fileUpload1" style="display: none">-->

                    <!--<td>  <input type="file"labelPosition="top"id="files1" name="files1" multiple="true" data-options="prompt:'选择文件...',buttonText:'选择'" style="width:250px"/>-->
                    <!--</td>-->
                <!--</tr>-->
                <tr>
                    <td colspan="4">
                        <table id="file_dg"></table>
                    </td>
                </tr>

            </table>
        </div>

    </div>

    <script>
    $.ajaxSettings.beforeSend = function(xhr, request) {
        xhr.setRequestHeader('csrf-token', '{{_csrfToken}}');
    }
</script>
<script type="text/javascript">
    var $list=$("#thelist");
    var status='{{status}}'
    var change_id='{{change_id}}'
    var proc_code='{{proc_code}}'
    var uploader;
    if(uploader){
        uploader.destroy();
    }
    uploader = WebUploader.create({
        auto:false,
        // swf文件路径
        swf: '{{projcfg.appurl}}/static/{{projcfg.theme}}webuploade/Uploader.swf',
        method:'POST',
        // 文件接收服务端。
        server: '{{projcfg.appurl}}/api/order_manage/order_list/uploadFile?_csrf=' + '{{_csrfToken}}',

        // 选择文件的按钮。可选。
        // 内部根据当前运行是创建，可能是input元素，也可能是flash.
        pick: '#picker',

        // 不压缩image, 默认如果是jpeg，文件上传前会压缩一把再上传！
        resize: false,
        // 只允许选择图片文件。
        accept: {
            title: '文件错误',
            extensions: 'gif,jpg,jpeg,bmp,png,mp3,wav,wma,pdf,txt,xls,xlsx',
            mimeTypes: '*'
        },
        fileNumLimit: 8, //限制上传个数
        fileSingleSizeLimit: 2048000 //限制单个上传图片的大小
    });

    /**
     * 验证文件格式
     */
    uploader.on("error", function (type) {
        if (type == "Q_TYPE_DENIED") {
            $.messager.alert('提示', "您上传的文件格式错误，请上传GIF,JPG,JPEG,BPM,PNG,MP3,WAV,WMA,PDF,txt,xls,xlsx格式文件");
        }else {
            $.messager.alert('提示', "上传出错！请检查后重新上传！错误代码"+type);
        }
    });

    // 当有文件被添加进队列的时候
    uploader.on( 'fileQueued', function( file ) {
        var $li = $(
                        '<div id="' + file.id + '" class="file-item thumbnail">' +
                        '<img>' +
                        '<div class="info">' + file.name + '</div>' +
                        '</div>'
                ),
                $img = $li.find('img');


        // $list为容器jQuery实例
        $list.append( $li );
        var thumbnailWidth = 100;   //缩略图高度和宽度 （单位是像素），当宽高度是0~1的时候，是按照百分比计算，具体可以看api文档
        var thumbnailHeight = 100;
        // 创建缩略图
        // 如果为非图片文件，可以不用调用此方法。
        // thumbnailWidth x thumbnailHeight 为 100 x 100
        uploader.makeThumb( file, function( error, src ) {   //webuploader方法
            if ( error ) {
                $img.replaceWith('<span>不能预览</span>');
                return;
            }

            $img.attr( 'src', src );
        }, thumbnailWidth, thumbnailHeight );
    });
    // 文件上传过程中创建进度条实时显示。
    uploader.on( 'uploadProgress', function( file, percentage ) {
        var $li = $( '#'+file.id ),
                $percent = $li.find('.progress span');

        // 避免重复创建
        if ( !$percent.length ) {
            $percent = $('<p class="progress"><span></span></p>')
                    .appendTo( $li )
                    .find('span');
        }

        $percent.css( 'width', percentage * 100 + '%' );
    });
    // 文件上传成功，给item添加成功class, 用样式标记上传成功。
    uploader.on('uploadSuccess', function (file) {
        $('#' + file.id).find('p.state').text('已上传');
    });
    // 文件上传失败，显示上传出错。
    uploader.on('uploadError', function (file) {
        $('#' + file.id).find('p.state').text('上传出错');
    });
   var fileLength=0;
   var count=0;
   // 完成上传完了，成功或者失败，先删除进度条。
   uploader.on( 'uploadComplete', function( file ) {
       $( '#'+file.id ).find('.progress').remove();
       //文件的id的最后是当前文件的下表
       count++;
       if(count==fileLength){
           msgSuccess('处理成功');
           $("#dd").dialog('close');
           $('#orderTablelist').datagrid('reload');
           $.messager.progress('close');
       }
   });

    //是否属于归档节点
    var endFlag=false;
    $(document).ready(function () {
        //状态1:已发起的工单,2：我的待办,3:我的已办，4：新增操作
//        var status=GetQueryString("status");
//
//        //状态为2时表示任务id，1和3时为实例id
//        var change_id=GetQueryString("change_id");
        if(status==1 ||status==3){
            //隐藏处理操作
            $("#order_detail").hide();
            $("#submitButton").hide();
        }else if(status==2){
            //待办操作

        }


        $.ajax({
            url: '{{projcfg.appurl}}/api/order_manage/order_list/orderDetail',
            type: 'post',
            dataType:'json',
            data: {
                "change_id":change_id,
                "status":status
            },
            success: function (data) {
                if(data.success){
                    //业务数据
                    var proc_vars=data.data.proc_vars;
                    //工单标题
                    var proc_title='';
                    //实例id
                    var inst_id;
                    var proc_vars_json=JSON.parse(proc_vars);
                    //待办标题字段不同
                    if(status==2){
                        proc_title=  data.data.proc_inst_task_title;
                        inst_id=data.data.proc_inst_id;
                        //当前节点
                        var node_code=data.data.proc_inst_task_code;
                        //任务id
                        var task_id=data.data._id;

                        //当前节点名称
                        var proc_inst_task_name= data.data.proc_inst_task_name;
                        $("#proc_inst_task_name").textbox("setValue",proc_inst_task_name);
                        //操作下拉框初始化
                        isEndNode(proc_code,node_code,task_id,inst_id,proc_vars_json.user_no,proc_vars_json.user_name);

                        $("#node_code").val(node_code);
                        $("#proc_inst_id").val(inst_id);
                        $("#proc_task_id").val(task_id);


                    }else{
                        proc_title=  data.data.proc_title;
                        inst_id=change_id;

                    }
                    $('#orderDetailForm1').form('load', proc_vars_json);
                    $("#proc_inst_name1").textbox('setValue','资金稽核工单2') ;
                    $("#proc_inst_task_title").textbox("setValue",proc_title);
                    $("#proc_task_code").val(proc_code);

                    //重新加载流程图
                    $('#tabs').tabs({
                        border:false,
                        onSelect:function(title,index){
                            if(title=='流程图'){
                                var url='{{projcfg.appurl}}/api/process/show/progressed?proc_inst_id='+inst_id;
                                document.getElementById("iframeId").src=url;
                            }

                        }
                    });

                    //流程日志
                    $('#dg').datagrid({
                        url:'{{projcfg.appurl}}/api/order_manage/order_complete/logs',
                        width:800,
                        queryParams: {
                            inst_id: inst_id
                        },
                        method:'post',
                        columns:[[
                            {field:'proc_inst_task_name',title:'节点名称',width:130, halign:'center',
                                formatter:function(value,row,index){

                                    return "<span title='" + value + "'>" + value + "</span>";

                                }},
                            {field:'proc_inst_task_assignee_name',title:'处理人',width:100, halign:'center'},
                            {field:'proc_inst_task_complete_time',title:'处理时间',width:145, halign:'center',
                                formatter:function(value,row,index){
                                    if(value!=null){
                                        var isoDateStr = value.substring(0,value.indexOf('.'));
                                        var date=new Date(isoDateStr.replace(/-/g,'/').replace(/T|Z/g,' '));
                                        date.setHours(date.getHours()+8)
                                        return  date.Format("yyyy-MM-dd hh:mm:ss");
                                    }else{
                                        return '';
                                    }

                                }},
                            {field:'proc_inst_task_remark',title:'处理意见',width:350,
                                halign:'center',
                                formatter: function (value) {
                                    return "<span style='width:80%;word-break:normal;display:block;white-space:pre-wrap;overflow:hidden;' title='" + value + "'>" + value + "</span>";
                                }}
                        ]]
                    })


                    //上传附件
                    $('#file_dg').datagrid({
                        url:'{{projcfg.appurl}}/api/order_manage/order_list/fileLogs',
                        width:800,
                        queryParams: {
                            inst_id: inst_id
                        },

                        method:'post',
                        columns:[[
                            {field:'_id',hidden:true},
                            {field:'file_name',title:'文件名',width:130, halign:'center',
                                formatter:function(value,row,index){

                                    return "<a href='{{projcfg.appurl}}/api/order_manage/order_list/download/"+row._id+"'>" + value + "</a>";

                                }},
                            {field:'file_path',title:'预览',width:130, halign:'center',height:130,
                                formatter:function(value,row,index){
                                    var extStart=row.file_name.lastIndexOf(".");
                                    var ext=row.file_name.substring(extStart,row.file_name.length).toUpperCase();


                                    var html='';
                                    if(ext=='.JPG' || ext=='.PNG'){
                                        html= '<div id="innerdiv" >'+
                                                '<img id="'+row._id+'"  style="height:130px;width:130px"  src="{{projcfg.appurl}}/api/order_manage/order_list/download/'+row._id+'/?t='+Math.random()+'" />'+
                                                '</div>'
                                    }else if(ext=='.MP3' || ext=='.WAV'|| ext=='.WMA'){
                                        html= '<div id="innerdiv" >'+
                                                '<audio  id="'+row._id+'"  src="{{projcfg.appurl}}/api/order_manage/order_list/download/'+row._id+'/?t='+Math.random()+'"  controls="controls"></audio>'+
                                                '</div>'
                                    }

                                    return html;

                                }},
                            {field:'proc_inst_task_type',title:'上传节点',width:120, halign:'center'},
                            {field:'user_name',title:'上传人',width:60, halign:'center'},
                            {field:'insert_time',title:'上传时间',width:150, halign:'center',
                                formatter:function(value,row,index){
                                    if(value!=null){
                                        var isoDateStr = value.substring(0,value.indexOf('.'));
                                        var date=new Date(isoDateStr.replace(/-/g,'/').replace(/T|Z/g,' '));
                                        date.setHours(date.getHours()+8)
                                        return  date.Format("yyyy-MM-dd hh:mm:ss");
                                    }else{
                                        return '';
                                    }
                                }},
                            {field:'proc_inst_task_remark',title:'操作',width:250,
                                halign:'center',
                                formatter: function (value,row,index) {
                                    var html='';
                                   // if(status != 1){
                                        html='<div style="text-align: center"><a href="javascript:void(0);" onclick="deleteFile(\''+row._id+'\')" >删除</a></div>';
                                   // }



                                    return html;
                                }}
                        ]]
                    })


                }else{
                    $.messager.alert('错误提示','工单创建失败');

                }
            }
        });



        //初始化工单类型下拉框
       // getAllProBase();



    });
    function GetQueryString(name) {
        var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if(r!=null)
            return  unescape(r[2]);
        return null;
    }
    /**
     * 初始化工单类型下拉框
     */
    function getAllProBase(){
        $("#proc_task_code").combobox({
            method: 'get',
            url: '{{projcfg.appurl}}/api/order_manage/order_list/proBase',
            valueField:'proc_code',
            textField:'proc_name'
        });

    }
    //时间格式化:new Date().Format("yyyy-MM-dd hh:mm:ss");
    Date.prototype.Format = function (fmt) { //author: meizz
        var o = {
            "M+": this.getMonth() + 1, //月份
            "d+": this.getDate(), //日
            "h+": this.getHours(), //小时
            "m+": this.getMinutes(), //分
            "s+": this.getSeconds(), //秒
            "q+": Math.floor((this.getMonth() + 3) / 3), //季度
            "S": this.getMilliseconds() //毫秒
        };
        if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in o)
            if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    }

    /**
     * 获取下一节点处理人
     */
    function getNextNodeUser(node_code,proc_task_id,proc_inst_id,user_no){
        var map ={};
        map.flag=""
        $.ajax({
            url: '{{projcfg.appurl}}/api/money_audit/money_audit_list2/nextNodeAnduser',
            type: 'post',
            dataType:'json',
            data: {
                node_code:node_code,
                proc_task_id:proc_task_id,
                proc_inst_id:proc_inst_id,
                params:JSON.stringify(map)
            },
            success: function (data) {
                if(data.success){
                    //初始化加载
                    $("#assign_user_no").combobox({
                        method: 'get',
                        valueField:'user_no',
                        textField:'user_name',
                        onSelect:function(record){
                            //下一节点处理编码赋值
                            $("#next_code").val(record.node_code);

                        }
                    });
                    $("#assign_user_no").combobox("loadData",data.data);
                }else{
                    $.messager.alert('错误提示','获取下一节点处理人失败，请联系管理员');
                }
            }
        });


    }

    //判断当前节点是否是归档节点
    function isEndNode(proc_code,node_code,task_id,inst_id){
        //判断是否是归档节点
        $.ajax({
            url: '{{projcfg.appurl}}/api/order_manage/order_list/procDefineDetail',
            type: 'post',
            dataType:'json',
            data: {
                proc_code:proc_code,
                node_code:node_code
            },
            success: function (data) {
                if(data.success){
                    var comboboxData=[];
                    //归档节点
                    if(data.data.isEnd){
                        //是归档节点不需要下一节点处理人
                        $("#tr_5").hide();
                        endFlag=true;
                        comboboxData.push({ value: '1', text: '归档' })  ;
                    }else{
                        //获取下一节点处理人
                        getNextNodeUser(node_code,task_id,inst_id);
                        $("#tr_5").show();
                        comboboxData.push({ value: '1', text: '通过' })  ;
                    }
                    if(data.data.haveRefuse){
                    //是否存在拒绝节点
                        comboboxData.push({ value: '0', text: '拒绝' })  ;
                    }
                    $("#handle") .combobox('loadData',comboboxData) ;
                    $("#handle") .combobox('setValue','1') ;
                }else{
                    $.messager.alert('错误提示',data.error);
                }
            }
        });
    }


    //提交任务
    function submitTask(){
        // 验证表单
       var validate = $('#orderDetailForm1').form('validate');
        if(!validate) {
            return false;
        }
        if(!$("#assign_user_no").combobox('getValue')&& !endFlag){
            $.messager.alert('提示','请选择下一节点处理人');
            return false;
        }

        $.messager.progress({
            title: '提示',
            msg: '处理中，请稍候……',
            text: ''
        });

        var formData=$('#orderDetailForm1').serializeArray();

        //归档
        if(endFlag){
            $.ajax({
                url: '{{projcfg.appurl}}/api/order_manage/order_list/complete',
                type: 'post',
                dataType:'json',
                data: formData,
                success: function (data) {
                    if(data.success){
                        if(uploader.getFiles().length > 0){
                            fileLength=  uploader.getFiles().length;
                            var obj = new Object();
                            obj.status = 1;
                            obj.proc_task_id = $("#proc_task_id").val();
                            uploader.options.formData = obj;
                            uploader.upload();
                        }else {
                            msgSuccess('处理成功');
                            $("#dd").dialog('close');
                            $('#orderTablelist').datagrid('reload');
                            $.messager.progress('close');
                        }
                    }else{
                        $.messager.progress('close');
                        $.messager.alert('错误提示',data.msg);
                    }
                }
            });
        }else{
            //中间节点处理

            //easyui textbox 设置为禁用 serializeJson 不能获取json
            formData.push({"name":"proc_inst_task_title",
                        "value":$("#proc_inst_task_title").textbox('getValue')});
          $.ajax({
                url: '{{projcfg.appurl}}/api/order_manage/order_list/assignTask',
                type: 'post',
                dataType:'json',
                data: formData,
                success: function (data) {
                    if(data.success){
                        if(uploader.getFiles().length > 0){
                            fileLength=  uploader.getFiles().length;
                            var obj = new Object();
                            obj.status = 1;
                            obj.change_id = $("#proc_task_id").val();
                            uploader.options.formData = obj;
                            uploader.upload();
                        }else {
                            msgSuccess('处理成功');
                            $("#dd").dialog('close');
                            $('#orderTablelist').datagrid('reload');
                            $.messager.progress('close');
                        }
                    }else{
                        $.messager.progress('close');
                        $.messager.alert('错误提示',data.error);
                    }
                }
            });
        }

    }


    /**
    * 删除上传附件
    * @param id
    */
    function deleteFile(id){
        $.ajax({
            url: '{{projcfg.appurl}}/api/order_manage/order_list/deleteFile',
            type: 'post',
            dataType:'json',
            data: {
                id:id,
            },
            success: function (data) {
                if(data.success){
                    $('#file_dg').datagrid('reload');
                }else{
                    $.messager.alert('删除失败');
                }
            }
        });
    }
    var file_id;
    function uploadFile(id){

        file_id=id;
        document.getElementById("file"+id).click();

    }
    /**
     * 上传
     */
    function doUploadCorrect() {
        var filepath = $("#file" + file_id).val();
        // 图片类型
        var extStart = filepath.lastIndexOf(".");
        var ext = filepath.substring(extStart, filepath.length).toUpperCase();

        if (ext != ".JPG" && ext != ".PNG" && ext != ".MP3" && ext != ".WAV" && ext != ".WMA") {
            $.messager.alert('提示', '文件限于jpg,png,MP3,WAV,WMA格式');
            return;
        }

        if (document.getElementById("file" + file_id).files[0].size > 1024 * 600) {
            $.messager.alert('提示', '文件:' + document.getElementById("file" + file_id).files[0].name + '必须小于600KB');
            return;
        }
        $.ajaxFileUpload({
            type: 'POST',
            url: '{{projcfg.appurl}}/api/order_manage/order_list/uploadFile?id=' + file_id + "&_csrf=" + '{{_csrfToken}}',
            secureuri: false,
            fileElementId: 'file' + file_id,     //与html代码中的input的id值对应
            dataType: 'json',
            success: function (data) {
                if (data.success) {
                    $.messager.alert('提示', '修正成功!');
                    $('#file_dg').datagrid('reload');//刷新
                } else {
                    $.messager.alert('警告', data.msg, 'error');
                }
            },
            error: function (err) {
                alert(JSON.stringify(err));
            }
        })
        document.getElementById('file' + file_id).outerHTML += "";
    }



    </script>




