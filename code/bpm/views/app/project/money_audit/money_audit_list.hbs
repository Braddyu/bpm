<link rel="stylesheet" type="text/css" href="{{projcfg.appurl}}/static/order/css/order_detail.css">
<link rel="stylesheet" type="text/css" href="{{projcfg.appurl}}/static/{{projcfg.theme}}js/uploadify/uploadify.css">
<script src="{{projcfg.appurl}}/static/js/ajaxfileupload.js"></script>
<script src="{{projcfg.appurl}}/static/{{projcfg.theme}}js/uploadify/jquery.uploadify.min.js"></script>
<div id="processDiv" class="row">
    <div class="col-xs-12 col-md-12">
        <div class="widget">
            <div class="widget-body">
                <div id="processLayout" class="easyui-layout" data-options="fit:true" style="width:600px;height:666px;">
                    <div id="toolbar1" class="row tbRow">
                        <div class="col-xs-8 col-md-8">
                            <div class="btn-group" role="group" aria-label="...">
                                <button type="button" class="btn btn-default" onclick="addDrafts()"><i class="fa fa-plus"></i>派单</button>
                            </div>
                        </div>
                        <div class="col-xs-4 col-md-4 text-right">
                            <form class="form-inline">
                                <div class="form-group">
                                    <div class="input-group">
                                        <input type="input" id="work_order_number" class="form-control" style="width:130px;" placeholder="输入工单编号查询"/>
                                        <span class="input-group-btn">
                                                <button class="btn btn-default" type="button" onclick="doSearch(1)"><i class="fa fa-search"></i>查询</button>
                                            </span>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                        <table id="orderTablelist">

                        </table>



                </div>
            </div>
        </div>
    </div>
</div>
<div id="dd"></div>

<div id="orderDetail"  class="mydialog"  >
    <form id="orderDetailForm" method="post" enctype="multipart/form-data">
        <fieldset>
            <legend ><b>任务基本信息</b></legend>

            <table cellpadding="5" align="center" style="border-collapse:separate; border-spacing:0px 5px;">
                <tr>
                    <input  type="hidden"id="_id"  name="_id"/>
                    <td align="right" class="tdLabel">工单标题:</td>
                    <td colspan="3"><input style="width: 665px" class="easyui-textbox"data-options="required:true, missingMessage:'请输入工单标题'" id="proc_title" name="proc_title" ></input></td>
                </tr>
                <tr>
                    <td align="right" class="tdLabel">工单类型:</td>
                    <td>
                        <input disabled style="width: 280px"class="easyui-textbox"
                               id="proc_inst_name"  name="proc_inst_name"></input>
                    </td>
                    <td align="right" class="tdLabel">工作天数:</td>
                    <td><input style="width: 280px"class="easyui-numberbox" data-options="precision:0,required:true, missingMessage:'请输入工作天数'"id="proc_work_day" name="proc_work_day"
                    ></input></td>
                </tr>
                <tr>
                    <td align="right" class="tdLabel">开始时间:</td>
                    <td><input readonly style="width: 280px"class="easyui-textbox"
                               id="start_time" name="start_time"></input></td>
                    <td align="right" class="tdLabel">完成时间:</td>
                    <td><input readonly style="width: 280px"  class="easyui-textbox"
                               id="end_time" name="end_time"></input></td>
                    <td colspan="2"></td>


                </tr>
                <tr>
                    <td align="right" class="tdLabel">发起人角色:</td>
                    <td><input disabled style="width: 280px"class="easyui-textbox"
                               id="user_role_names" ></input></td>

                    <td align="right" class="tdLabel">发起人:</td>
                    <td><input disabled style="width: 280px" class="easyui-textbox"
                               id="start_name" ></input></td>

                </tr>


                <tr>
                    <td align="right" class="tdLabel">派单内容:</td>
                    <td colspan="3"><input
                            style="width: 670px; height: 50px; resize: none;" cols="30"
                            name="proc_content" id="proc_content" rows="4"  class="easyui-textbox"  labelPosition="top" multiline="true"/>

                    </td>
                </tr>
            </table>


            <legend><b>节点处理</b></legend>

            <table cellpadding="5" align="center" style="border-collapse:separate; border-spacing:0px 5px;">
                <input  type="hidden"id="proc_name"  name="proc_name"/>
                <input  type="hidden"id="proc_ver"  name="proc_ver"/>

                <tr>
                    <td  align="right" class="tdLabel">处理人机构：</td>
                    <td colspan="3" class="tdLabel"><select  class="easyui-combobox" id="orgId"  style="width: 80%;height:40px;"></select></td>
                </tr>
                <tr id="tr_5">
                    <td align="right" class="tdLabel">处理人:</td>
                    <td colspan="3" class="tdLabel"><select class="easyui-combobox"
                                            id="assign_user_no"name="assign_user_no" style="width: 180px;">
                    </select> </td>


                </tr>

                <tr  id="fileUpload">
                    <td align="right" class="tdLabel">附件上传:</td>
                    <td>  <input type="file"labelPosition="top"id="files" name="files" multiple="true" data-options="prompt:'选择文件...',buttonText:'选择'" style="width:250px"/>
                    </td>
                </tr>

                <input type='hidden' name='_csrf' value='{{ _csrfToken }}'/>
            </table>
        </fieldset>

    </form>

</div>

<script>
    $.ajaxSettings.beforeSend = function(xhr, request) {
        xhr.setRequestHeader('csrf-token', '{{_csrfToken}}');
    }
</script>
<script type="text/javascript">
    $(function() {
        $('#files').uploadify({
            'swf'      : '{{projcfg.appurl}}/static/{{projcfg.theme}}js/uploadify/uploadify.swf',
            'uploader' : '{{projcfg.appurl}}/api/order_manage/order_list/uploadFile?_csrf='+'{{_csrfToken}}',
            'auto'           :false,
            'multi'          :true,
            'buttonText':'附件上传',
            'fileTypeExts' : '*.gif; *.jpg; *.png;*.mp3;*.wav;*.wma;*.pdf;*.txt;*.xls;*.xlsx',
            'checkExisting':true,
            'fileSizeLimit':'5MB',
            //浏览按钮的宽度
            'width':'100',
            //浏览按钮的高度
            'height':'30',
            'onQueueComplete' : function(queueData) {
                $.messager.alert('提示','处理成功');
                $('#orderDetail').dialog("close");
                $('#orderTablelist').datagrid('reload');
            }
        });

    });


    $(document).ready(function () {

        //加载列表
        loadOrderListDatagrid();
        //初始化工单类型下拉框
        //getAllProBase();
        //这里combobox默认会赋一个的选项的值
        loadOrgTree();//加载机构树
       // $("#assign_user_no") .combobox('setValue','') ;
        $("#handle") .combobox('setValue','') ;
        //填写工作天数，给完成时间赋值
        $('#proc_work_day').textbox({
            onChange: function(value) {
                if(value!=''&&value!=null){
                    var time=new Date($("#start_time").textbox("getValue"));
                    var work_day= parseInt(value);
                    time.setDate(time.getDate()+work_day);
                    $("#end_time").textbox("setValue",time.Format("yyyy-MM-dd hh:mm:ss"));
                }else{
                    $("#end_time").textbox("setValue","");
                }


            }
        });
    });

    //时间格式化:new Date().Format("yyyy-MM-dd hh:mm:ss");
    Date.prototype.Format = function (fmt) { //author: meizz
        var o = {
            "M+": this.getMonth() + 1, //月份
            "d+": this.getDate(), //日
            "h+": this.getHours(), //小时
            "m+": this.getMinutes(), //分
            "s+": this.getSeconds(), //秒
            "q+": Math.floor((this.getMonth() + 3) / 3), //季度
            "S": this.getMilliseconds() //毫秒
        };
        if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in o)
            if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    }

    //加载机构树
    function loadOrgTree(){
        $('#orgId').combotree({
            method: 'get',
            url: '{{projcfg.appurl}}/api/money_audit/money_audit_list/orgTreeDataAsyn?org_pid=0',
            //url: '{{projcfg.appurl}}/process/orgTreeData',
            onBeforeExpand:function(node,param){
                $('#orgId').combotree("tree").tree("options").url =  '{{projcfg.appurl}}/api/money_audit/money_audit_list/orgTreeDataAsyn?org_pid=' + node.id;
            },
            editable:false,
//                    required:true,
            multiple : false,
            cascadeCheck : false,
            onSelect:function(record){
                $('#assign_user_no').combobox('clear');
                loadOrgPeason(record.id);
            }
        });
    }

    //加载机构下的人员
    function loadOrgPeason(orgId){
        $("#assign_user_no").combobox({
            method: 'get',
            url: '{{projcfg.appurl}}/api/money_audit/money_audit_list/getOrgPeason?orgId='+orgId,
            valueField:'user_no',
            textField:'user_name'
        });
    }

    function loadOrderListDatagrid(){
        // 加载工单基本属性列表
        $('#orderTablelist').datagrid({
            url:'{{projcfg.appurl}}/api/money_audit/money_audit_list/list',
            method:'post',
            rownumbers:true,
            striped:true,
            fitColumns:true,
            border:false,
            fit:true,
            toolbar: '#toolbar1',
            singleSelect:true,
            selectOnCheck:true,
            checkOnSelect:true,
            pageSize: 20,
            columns:[[
                {"field":"_id",checkbox:true},
                {"field": "work_order_number","title":"工单编号","width":55},
                {"field": "proc_title","title":"工单标题","width":100,
                    formatter:function(value,row,index){
                        return "<span title='" + value + "'>" + value + "</span>";

                    }},
                {"field": "proc_peason_type","title":"人员类型","width":50,
                    formatter:function(value,row,index){
                        var proc_vars_json=JSON.parse(row.proc_vars);
                        var myval = proc_vars_json.proc_inst_name;alert(row.proc_vars);
                        return myval;
                    }},
                {"field": "proc_name","title":"所属流程","width":50},
                {"field": "proc_ver","title":"版本","width":20},
                {"field": "proc_cur_task_name","title":"当前处理节点","width":50},
                {"field": "proc_inst_status","title":"状态","width":50,
                    formatter:function(value,row,index){
                        //1 已启用  0 已禁用,2 流转中，3子流程流转中 ,4  归档,5 回退，6 废弃
                        if(value == '1'){
                            return "启用";
                        }else if(value == '2'){
                            return "流转中";
                        }else if(value == '3'){
                            return "子流程流转中";
                        }else if(value == '4'){
                            return "归档";
                        }else if(value == '5'){
                            return "回退";
                        }else if(value == '6'){
                            return "废弃";
                        }else if(value == '0'){
                            return "已禁用";
                        }

                    }
                },
                {"field": "proc_start_user_name","title":"申请人","width":50},
                {"field": "proc_start_time","title":"创建时间","width":80,
                    formatter:function(value,row,index){
                        return  new Date(value).Format("yyyy-MM-dd hh:mm:ss");
                    }}
            ]],
            onDblClickRow:function(rowIndex, rowData){

                var url='{{projcfg.appurl}}/api/order_manage/order_list/showDetailView?proc_code='+rowData.proc_code+'&change_id='+rowData._id+'&status=1';
                var content = '<iframe src="'+url+'" width="100%" height="99%" frameborder="0" scrolling="yes"></iframe>';
                $('#dd').dialog({
                    title : '工单详情',
                    width : 1250,
                    height : 650,
                    closed : false,
                    cache : false,
                    content :content ,
                    modal : true
                });
            },
            onLoadSuccess:function(json) {
                if(!json.success) {
                    msgError(json.msg + ',错误代码:' + json.code);
                }
            },
            onLoadError:function() {
                msgError('加载数据出现时发生错误,请稍候重试...');
            },
            pagination:true,
            loadMsg:'正在加载...'
        });
    }

    //新增工单
    function addDrafts(){
        $('#orderDetailForm').form('clear');
        //当前登录用户名
        var user_name = '{{currentUser.user_name}}';
        //用户角色
        var user_roles = '{{currentUserRole.role_name}}';
        //用户名
        $("#start_name").textbox("setValue",user_name);
        //用户角色
        $("#user_role_names").textbox("setValue","省级资金稽核管理人");
        $("#proc_inst_name").textbox('setValue','资金稽核工单') ;
        $("#handle").combobox("setValue","1");

        //当前填单时间
        var time=new Date();
        $("#start_time").textbox("setValue",time.Format("yyyy-MM-dd hh:mm:ss"));
        $('#orderDetail').show();
        $('#orderDetail').mydialog({
            title:"资金稽核工单派单",
            width: 900,
            height: 550,
            top:150,
            modal: true,
            myButtons:[
                {
                    text:'提交',
                    btnCls:'btn btn-blue',
                    handler:function(){
                        saveNewOrder();
                    }
                },
//                {
//                    text:'暂存',
//                    btnCls:'btn btn-blue',
//                    handler:function(){
//                        saveDrafts();
//                    }
//                },
                {
                    text:'关闭',
                    btnCls:'btn btn-danger',
                    handler:function(){
                        $('#orderDetail').dialog("close");
                    }
                }
            ]
        });
    }

    /**
     * 初始化工单类型下拉框
     */
    function getAllProBase(){
        $.ajax({
            url: '{{projcfg.appurl}}/api/order_manage/order_list/procDefineDetail',
            type: 'post',
            dataType:'json',
            data: {proc_code:"p_222",node_code:"processDefineDiv_node_3"},
            success: function (data) {
                if(data.success){
                    $("#proc_inst_task_name").textbox("setValue",data.data.nodeName);
                }else{
                    $("#proc_inst_task_name").textbox("setValue","");
                    $.messager.alert('错误提示',data.error);
                }
            }
        });

    }

    /**
     * 暂存草稿箱
     */
    function saveDrafts(){
        // 验证表单
        var validate = $('#orderDetailForm').form('validate');
        if(!validate) {
            return false;
        }
        $.ajax({
            url: '{{projcfg.appurl}}/api/order_manage/order_drafts/saveDrafts',
            type: 'post',
            dataType:'json',
            data: $('#orderDetailForm').serializeJson(),
            success: function (data) {
                if(data.success){

                    $('#orderDetail').dialog("close");
                    $('#orderTablelist').datagrid('reload');
                    $.messager.alert('提示','保存成功');


                }else{
                    $.messager.alert('错误提示',data.error);

                }
            }
        });
    }

    // 修改草稿箱

    function editDrafts(){
        var row = $('#orderTablelist').datagrid('getSelected');
        if(row) {
            $('#orderDetailForm').form('clear');
            //当前登录用户名
            var user_name = '{{currentUser.user_name}}';
            //用户角色
            var user_roles = '{{currentUserRole.role_name}}';
            //用户名
            $("#start_name").textbox("setValue", user_name);
            //用户角色
            $("#user_role_names").textbox("setValue", user_roles);
            $("#handle").combobox("setValue", "1");

            //当前填单时间
            var time = new Date();
            $("#start_time").textbox("setValue", time.Format("yyyy-MM-dd hh:mm:ss"));

            //回填当前节点
            $.ajax({
                url: '{{projcfg.appurl}}/api/order_manage/order_list/procDefineDetail',
                type: 'post',
                dataType: 'json',
                data: {proc_code: row.proc_code},
                success: function (data) {
                    //回填当前节点名称
                    if (data.success) {
                        $("#proc_inst_task_name").textbox("setValue", data.data.nodeName);
                    } else {
                        $("#proc_inst_task_name").textbox("setValue", "");
                        $.messager.alert('错误提示', data.error);
                    }
                }
            });

            $('#orderDetailForm').form('load', row);
            $('#orderDetail').show();
            $('#orderDetail').mydialog({
                title: "新增资金稽核工单",
                width: 900,
                height: 550,
                top: 150,
                modal: true,
                myButtons: [
                    {
                        text: '提交',
                        btnCls: 'btn btn-blue',
                        handler: function () {
                            saveNewOrder();
                        }
                    },
                    {
                        text: '暂存',
                        btnCls: 'btn btn-blue',
                        handler: function () {
                            saveDrafts();
                        }
                    },
                    {
                        text: '关闭',
                        btnCls: 'btn btn-danger',
                        handler: function () {
                            $('#orderDetail').dialog("close");
                        }
                    }
                ]
            });
        }else{
            $.messager.alert('提示','请先选择');

        }
    }
    /**
     * 删除草稿箱
     */
    function deleteDrafts(){
        var row = $('#orderTablelist').datagrid('getSelected');
        if(row){
            //删除工单
            $.ajax({
                url: '{{projcfg.appurl}}/api/order_manage/order_drafts/deleteDrafts',
                type: 'post',
                dataType:'json',
                data: {_id:row._id},
                success: function (data) {
                    if(data.success){
                        $('#orderTablelist').datagrid('reload');
                        $.messager.alert('提示','删除成功');
                    }else{
                        $.messager.alert('错误提示',data.error);
                    }
                }
            });
        }else{
            $.messager.alert('提示','请先选择');

        }

    }
    /**
     * 提交新工单
     */
    function saveNewOrder(){
        // 验证表单
        var validate = $('#orderDetailForm').form('validate');
        if(!validate) {
            return false;
        }
        //下一节点处理人必选
        if(!$("#assign_user_no").combobox('getValue')){
            $.messager.alert('提示','请选择下一节点处理人');
            return false;
        }

        $.messager.confirm('提示','确定提交工单吗?',function(r){
            if (r){
                $.ajax({
                    url: '{{projcfg.appurl}}/api/money_audit/money_audit_list/moneyAudit',
                    type: 'post',
                    dataType:'json',
                    data: $('#orderDetailForm').serializeJson(),
                    success: function (data) {
                        if(data.success){
                            if($('#files').data('uploadify').queueData.queueLength > 0) {
                                var proc_task_id = data.data;
                                $('#files').uploadify('settings', "formData",
                                        {'status': 1, 'id': proc_task_id});
                                $('#files').uploadify('upload', '*')
                            }else {
                                $.messager.alert('提示','处理成功');
                                $('#orderDetail').dialog("close");
                                $('#orderTablelist').datagrid('reload');
                            }
                        }else{
                            $.messager.alert('错误提示',data.error);

                        }
                    }
                });
            }
        });


    }

    //查询
    function  doSearch(){
        $('#orderTablelist').datagrid({
            url: '{{projcfg.appurl}}/api/order_manage/order_list/list',
            queryParams: {
               proc_code: "p_444",
                proc_peason_type:$("#proc_peason_type").combobox('getValue'),
//                startDate: $("#startDate").datebox('getValue'),
//                endDate: $("#endDate").datebox('getValue'),
                work_order_number:$("#work_order_number").val(),

            }
        });
    }
</script>